<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Anexo Cobro v6.1.152</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Prevent Caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="/index.css">
</head>

<body>
  <!-- VERSION_V5_2_0_FORCE_REDEPLOY -->
  <div id="error-trap"
    style="display:none; color:red; padding:20px; font-family:monospace; background:white; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999;">
  </div>

  <script>
    (function () {
      var CURRENT_VERSION = '6.1.152';
      var storedVersion = localStorage.getItem('pwa_app_version');
      if (storedVersion !== CURRENT_VERSION) {
        localStorage.setItem('pwa_app_version', CURRENT_VERSION);
        // Clear ALL service workers AND all CacheStorage caches
        var cleanAndReload = function () {
          window.location.href = window.location.pathname + '?reload=' + Date.now();
        };
        if ('caches' in window) {
          caches.keys().then(function (names) {
            return Promise.all(names.map(function (n) { return caches.delete(n); }));
          }).then(function () {
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(function (regs) {
                return Promise.all(regs.map(function (r) { return r.unregister(); }));
              }).then(cleanAndReload).catch(cleanAndReload);
            } else {
              cleanAndReload();
            }
          }).catch(cleanAndReload);
        } else if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(function (regs) {
            return Promise.all(regs.map(function (r) { return r.unregister(); }));
          }).then(cleanAndReload).catch(cleanAndReload);
        } else {
          cleanAndReload();
        }
        return; // Stop execution, reload is imminent
      }
    })();

    // --- MECANISMO DE RECUPERACI√ìN (Anti-Pantalla en Blanco) ---
    (function () {
      const BOOT_TIMEOUT = 10000; // 10 segundos para considerar arranque fallido
      let bootFinished = false;

      window.addEventListener('load', () => {
        setTimeout(() => {
          bootFinished = true;
          console.log("Sistema cargado establemente.");
        }, BOOT_TIMEOUT);
      });

      const handlePanic = (msg) => {
        if (bootFinished) return;
        console.error("Error cr√≠tico de arranque:", msg);

        var trap = document.getElementById('error-trap');
        if (trap) {
          trap.style.display = 'block';
          trap.innerHTML = `
            <div style="background:#0f172a; color:white; height:100vh; padding:20px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;">
              <h1 style="font-size:60px; margin:0;">üõ†Ô∏è</h1>
              <h2 style="font-size:20px; font-weight:bold; margin:10px 0; color:#f1f5f9;">SISTEMA EN REPARACI√ìN</h2>
              <p style="color:#94a3b8; margin-bottom:20px; font-size:14px; max-width:300px;">La app detect√≥ un problema t√©cnico. Pulsa abajo para resetearla.</p>
              
              <div style="background:#1e293b; padding:15px; border-radius:12px; border:1px solid #334155; width:100%; max-width:400px; margin-bottom:20px; text-align:left;">
                <p style="color:#ef4444; font-size:10px; font-weight:bold; text-transform:uppercase; margin:0 0 5px 0;">Error:</p>
                <pre style="font-size:10px; color:#cbd5e1; margin:0; white-space:pre-wrap; word-break:break-all; max-height:200px; overflow:auto;">${msg}</pre>
              </div>

              <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload(true);" 
                style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; padding:18px 36px; border-radius:20px; font-weight:bold; border:none; cursor:pointer; box-shadow:0 10px 20px -5px rgba(59,130,246,0.6); font-size:15px; transition: transform 0.2s;">
                REPARAR AHORA
              </button>
            </div>
          `;
        }
      };

      window.addEventListener('error', (e) => handlePanic(e.message));
      window.addEventListener('unhandledrejection', (e) => handlePanic(e.reason?.message || "Error Desconocido"));
    })();
  </script>
  <div id="root"></div>
  <script type="module" src="/index.tsx"></script>
</body>

</html>